<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬í‘œ ëŒ€ì‹  ì´ë‹¨ ì˜†ì°¨ê¸°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gaegu&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: #f0f0f0;
            font-family: 'Gaegu', cursive;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #game-container {
            position: relative;
            width: 800px; 
            height: 600px;
        }

        canvas {
            display: block;
            background: #fff;
            border: 4px solid black;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.1);
            border-radius: 10px;
            width: 100%;
            height: 100%;
        }

        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            font-family: 'Gaegu', cursive;
            text-align: center;
            border-radius: 10px;
        }
        
        #start-overlay h1 { font-size: 40px; }
        #start-overlay input { padding: 10px; font-size: 20px; margin-bottom: 20px; border: 2px solid black; }
        #start-overlay button { 
            padding: 15px 30px; 
            font-size: 24px; 
            background: #ffeb3b; 
            border: 2px solid black; 
            box-shadow: 4px 4px 0 black; 
            cursor: pointer;
        }


        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            z-index: 50;
        }

        .guide {
            font-size: 20px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border: 2px solid black;
            border-radius: 10px;
        }

        /* PC í‚¤ë³´ë“œ ê°€ì´ë“œ - ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ¨ê¹€ */
        .pc-guide {
            display: block; 
        }

        /* ë¶„ë…¸ ê²Œì´ì§€ ì»¨í…Œì´ë„ˆ */
        #rage-bar-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            z-index: 60;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 5px;
            border: 3px solid #ff4500;
            box-shadow: 0 0 10px #ff4500;
            display: none; 
            flex-direction: column;
            align-items: center;
        }

        #rage-bar-label {
            color: white;
            font-size: 24px;
            margin-bottom: 5px;
            text-shadow: 2px 2px 0 black;
        }

        #rage-bar {
            height: 25px;
            width: 100%;
            background: #444;
            border-radius: 3px;
            overflow: hidden;
        }

        #rage-fill {
            height: 100%;
            width: 100%; 
            background: linear-gradient(to right, #ff4500, #ff0000);
            transition: width 0.3s ease-out;
        }


        #mobile-controls {
            position: absolute;
            bottom: 10px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 10px;
            z-index: 100;
        }

        .dpad, .action-buttons, .weapon-buttons {
            display: flex;
            gap: 5px;
        }

        .dpad {
            flex-direction: column;
            align-items: center;
            width: 150px;
            margin-right: auto;
        }

        .dpad-row {
            display: flex;
            gap: 5px;
        }

        .action-buttons, .weapon-buttons {
            align-self: flex-end; 
        }
        .weapon-buttons {
            margin-top: -5px; 
        }


        .ctrl-btn {
            width: 50px;
            height: 50px;
            background: #ffeb3b;
            border: 2px solid black;
            font-family: 'Gaegu', cursive;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            cursor: pointer;
            box-shadow: 3px 3px 0 black;
            transition: none;
            border-radius: 5px;
        }
        
        .ctrl-btn:active {
            box-shadow: 1px 1px 0 black;
            transform: translate(2px, 2px);
        }

        /* ë¬´ê¸° ë²„íŠ¼ ì „ìš© ìŠ¤íƒ€ì¼ */
        .weapon-btn {
            background: #aaffaa; 
            font-size: 16px;
            width: 65px; 
        }

        @media (max-width: 820px) {
            #game-container {
                width: 95vw;
                height: 95vw; 
                max-width: 600px;
                max-height: 600px;
            }
            .guide { font-size: 16px; }
            #mobile-controls { display: flex; }
            #rage-bar-container { width: 90%; top: 5px; } 
            .pc-guide { display: none; } 

            #ui-layer {
                top: 70px; 
                left: 10px;
            }
            #weapon-guide {
                background: none; 
                border: none; 
                padding: 0;
            }
        }
        @media (min-width: 821px) {
            #mobile-controls { display: none; }
        }

        #hit-effect {
            position: absolute;
            font-size: 40px;
            font-weight: bold;
            color: red;
            pointer-events: none;
            text-shadow: 2px 2px 0 black;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #end-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            font-family: 'Gaegu', cursive;
            text-align: center;
        }

        #end-screen h1 {
            font-size: 60px;
            color: #ffeb3b;
            text-shadow: 4px 4px 0 #ff4500;
            margin-bottom: 20px;
        }
        
        #end-screen p {
            font-size: 30px;
        }

    </style>
</head>
<body>

<div id="start-overlay">
    <h1>ğŸƒâ€â™€ï¸ ì‚¬í‘œ ëŒ€ì‹  ì´ë‹¨ ì˜†ì°¨ê¸°</h1>
    <p>ìƒì‚¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</p>
    <input type="text" id="bossNameInput" value="ê¹€ë¶€ì¥">
    <button onclick="startGame()">ì¶œê·¼í•˜ê¸° (ê²Œì„ ì‹œì‘)</button>
    <p style="font-size: 14px; color: #666;">* ì†Œë¦¬ ì¼œê³  í¬ë¡¬ ë¸Œë¼ìš°ì € ê¶Œì¥ *</p>
</div>

<div id="game-container">
    <div id="ui-layer">
        <div class="guide pc-guide">
            **PC í‚¤ë³´ë“œ**<br>
            ì´ë™: â¬…ï¸â¬†ï¸â¬‡ï¸â¡ï¸ ë°©í–¥í‚¤<br>
            ëŒ€í™”: **E** í‚¤<br>
            ê³µê²©: **Space** í‚¤
        </div>
        <div id="weapon-guide" class="guide" style="margin-top: 10px;">
            í˜„ì¬ ë¬´ê¸°: [1] ê¿€ë°¤ (Lv.1)
        </div>
    </div>
    
    <div id="rage-bar-container">
        <div id="rage-bar-label">ìƒì‚¬ ë¶„ë…¸ ê²Œì´ì§€ (HP)</div>
        <div id="rage-bar"><div id="rage-fill"></div></div>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div id="mobile-controls">
        <div class="dpad">
            <div class="dpad-row">
                <div class="ctrl-btn" data-key="ArrowUp" style="visibility:hidden;"></div>
                <div class="ctrl-btn" data-key="ArrowUp">â¬†ï¸</div>
                <div class="ctrl-btn" data-key="ArrowUp" style="visibility:hidden;"></div>
            </div>
            <div class="dpad-row">
                <div class="ctrl-btn" data-key="ArrowLeft">â¬…ï¸</div>
                <div class="ctrl-btn" data-key="NoKey"></div>
                <div class="ctrl-btn" data-key="ArrowRight">â¡ï¸</div>
            </div>
            <div class="dpad-row">
                <div class="ctrl-btn" data-key="ArrowDown" style="visibility:hidden;"></div>
                <div class="ctrl-btn" data-key="ArrowDown">â¬‡ï¸</div>
                <div class="ctrl-btn" data-key="ArrowDown" style="visibility:hidden;"></div>
            </div>
        </div>

        <div>
            <div class="weapon-buttons">
                <div class="ctrl-btn weapon-btn" data-weapon="0">ê¿€ë°¤</div>
                <div class="ctrl-btn weapon-btn" data-weapon="1">ë¿…ë§ì¹˜</div>
                <div class="ctrl-btn weapon-btn" data-weapon="2">ì„œë¥˜</div>
                <div class="ctrl-btn weapon-btn" data-weapon="3">ì˜†ì°¨ê¸°</div>
            </div>
            <div class="action-buttons">
                <div class="ctrl-btn" data-key="KeyE" style="background:#4CAF50;">ğŸ—£ï¸ Talk (E)</div>
                <div class="ctrl-btn" data-key="Space" style="background:#F44336;">ğŸ¦¶ Attack (Space)</div>
            </div>
        </div>
    </div>
    
    <div id="end-screen">
        <h1>ì¶•í•˜í•©ë‹ˆë‹¤!</h1>
        <p id="end-message"></p>
        <p style="margin-top: 50px;">ìƒˆë¡œìš´ ë§ˆìŒìœ¼ë¡œ ë‹¤ì‹œ ì¶œê·¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <button onclick="window.location.reload()" style="padding: 15px 30px; font-size: 24px; background: #ffeb3b; border: 2px solid black; box-shadow: 4px 4px 0 black; cursor: pointer;">ì¬ì‹œì‘</button>
    </div>
</div>

<div id="hit-effect"></div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const controls = document.querySelectorAll('.ctrl-btn');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)(); 

    // ê²Œì„ ìƒíƒœ
    let gameRunning = false;
    let bossName = "ê¹€ë¶€ì¥";
    let keys = {};
    let isTalking = false; 
    let currentNag = "...";
    let currentWeapon = 0; 
    let speechPhase = 0; 

    // ë¬´ê¸° ëª©ë¡ (reaction í…ìŠ¤íŠ¸ë§Œ ì‚¬ìš©)
    const weapons = [
        { name: "ê¿€ë°¤ (Lv.1)", range: 30, text: "ë”±!", color: "#ff8c00", reaction: "í¬í", damage: 20 },
        { name: "ë¿…ë§ì¹˜ (Lv.2)", range: 50, text: "ë¿…!", color: "#00bfff", reaction: "ì¼!", damage: 40 },
        { name: "ì„œë¥˜ ë­‰ì¹˜ (Lv.3)", range: 100, text: "íœ˜ë¦­!", color: "#228b22", reaction: "ì•…!", damage: 60 },
        { name: "ì´ë‹¨ ì˜†ì°¨ê¸° (Lv.4)", range: 120, text: "í½!!", color: "red", reaction: "ì»¤í—‰!", damage: 80 }
    ];

    // í”Œë ˆì´ì–´/ë³´ìŠ¤/ë°ìŠ¤í¬ ë°ì´í„°
    const player = { x: 100, y: 300, speed: 4, isAttacking: false, attackTimer: 0, attackDuration: 15 };
    const BOSS_START_X = 600;
    const BOSS_START_Y = 300;
    const boss = { 
        x: BOSS_START_X, y: BOSS_START_Y, 
        isHit: false, hitTimer: 0, hitDuration: 15,
        health: 1000, 
        maxHealth: 1000,
        isQuitting: false 
    };
    const desks = [
        {x: 100, y: 100, w: 120, h: 60}, {x: 300, y: 100, w: 120, h: 60}, {x: 500, y: 100, w: 120, h: 60},
        {x: 100, y: 450, w: 120, h: 60}, {x: 300, y: 450, w: 120, h: 60},
    ];

    // ìƒì‚¬ ì”ì†Œë¦¬ (ìˆœìˆ˜ í…ìŠ¤íŠ¸ ë°°ì—´ - TTSë¡œ ì½í˜)
    const nags = [
        "ì–´ì´~ ê±°ê¸° ë­í•´?", 
        "ë¼ë–¼ëŠ” ë§ì´ì•¼~", 
        "ì˜¤ëŠ˜ íšŒì‹ í•„ì°¸ì´ì•¼!", 
        "ì´ê±° í°íŠ¸ê°€ ë³„ë¡œë„¤.",
        "ì£¼ë§ì— ë“±ì‚° ê°ˆê¹Œ?", 
        "ìë„¤, ì—´ì •ì´ ë¶€ì¡±í•´.",
        "ê°€ì¡± ê°™ì€ íšŒì‚¬ì–ì•„ ^^"
    ];
    
    const TALK_RANGE = 150;


    // ------------------------------------------
    // SFX/ë¦¬ì•¡ì…˜ í•¨ìˆ˜ (TTS ê¸°ë°˜)
    // ------------------------------------------
    function playHitSound(level) {
        if (audioCtx.state === 'suspended') audioCtx.resume(); 

        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        const frequency = 1600 - (level * 200); 

        oscillator.type = 'square';
        oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15); 

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.15);
    }
    
    // [TTS] ë³´ìŠ¤ í”¼ê²© ë¦¬ì•¡ì…˜ (ë§¤ìš° ë¹ ë¥´ê³  ë†’ì€ í†¤)
    function bossReactToHit(reactionText) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        
        const msg = new SpeechSynthesisUtterance(reactionText);
        msg.lang = 'ko-KR';
        msg.pitch = 2.0; 
        msg.rate = 2.0;  
        
        msg.onstart = () => { currentNag = reactionText; };
        msg.onend = () => { currentNag = "..."; };
        
        window.speechSynthesis.speak(msg);
    }

    // ------------------------------------------
    // ëŒ€í™” ë¡œì§ (TTS ê¸°ë°˜)
    // ------------------------------------------

    function checkTalkStart() {
        if (!gameRunning || boss.isQuitting) return; 

        const dx = player.x - boss.x;
        const dy = player.y - boss.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < TALK_RANGE && speechPhase === 0 && !boss.isHit) {
            playerSpeak();
        }
    }

    // [TTS] í”Œë ˆì´ì–´ ëŒ€í™”
    function playerSpeak() {
        if (!window.speechSynthesis) return;

        const playerLine = "ì•¼, " + bossName + "!";
        currentNag = playerLine;

        window.speechSynthesis.cancel(); 

        const msg = new SpeechSynthesisUtterance(playerLine);
        msg.lang = 'ko-KR';
        msg.pitch = 1.0; 
        msg.rate = 0.8;  
        
        msg.onstart = () => { 
            isTalking = true;
            speechPhase = 1; 
        };
        msg.onend = () => { 
            bossSpeak();
        };
        
        window.speechSynthesis.speak(msg);
    }

    // [TTS] ìƒì‚¬ ì”ì†Œë¦¬
    function bossSpeak() {
        if (!window.speechSynthesis) return;
        
        const randomNag = nags[Math.floor(Math.random() * nags.length)];

        window.speechSynthesis.cancel(); 

        const msg = new SpeechSynthesisUtterance(randomNag);
        msg.lang = 'ko-KR';
        msg.pitch = 2.0; 
        msg.rate = 1.3;  
        
        msg.onstart = () => { 
            isTalking = true;
            speechPhase = 2; 
        };
        msg.onend = () => { 
            isTalking = false; 
            speechPhase = 0; 
            currentNag = "..."; 
        };
        
        window.speechSynthesis.speak(msg);
        currentNag = randomNag;
    }
    
    // ------------------------------------------
    // ë¶„ë…¸ ê²Œì´ì§€ ë° ì¢…ë£Œ ë¡œì§
    // ------------------------------------------

    function updateRageBar() {
        const percent = Math.max(0, boss.health / boss.maxHealth) * 100;
        document.getElementById('rage-fill').style.width = percent + '%';
    }

    function endGame(status) {
        gameRunning = false;
        window.speechSynthesis.cancel();
        
        if (status === 'win') {
            boss.isQuitting = true;
            document.getElementById('end-message').innerText = 
                `ìƒì‚¬ ${bossName} ë‹˜ê»˜ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ë¡œ ì¸í•´ ì‚¬ì§ì„œë¥¼ ì œì¶œí•˜ê³  í‡´ì‚¬í•˜ì…¨ìŠµë‹ˆë‹¤!`;
        }
        
        document.getElementById('end-screen').style.display = 'flex';
    }


    // ------------------------------------------
    // ê³µê²© ë¡œì§ 
    // ------------------------------------------

    function attack() {
        if (player.isAttacking || !gameRunning || boss.isQuitting) return;

        const dx = player.x - boss.x;
        const dy = player.y - boss.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const weapon = weapons[currentWeapon];

        if (dist < weapon.range) { 
            
            boss.health -= weapon.damage;
            if (boss.health <= 0) {
                endGame('win');
                return;
            }
            
            playHitSound(currentWeapon + 1);
            // reaction í…ìŠ¤íŠ¸ë¥¼ TTS í•¨ìˆ˜ì— ì „ë‹¬
            bossReactToHit(weapon.reaction); 

            player.isAttacking = true;
            player.attackTimer = player.attackDuration;
            boss.isHit = true;
            boss.hitTimer = boss.hitDuration;
            
            if (currentWeapon === 3) {
                boss.x += 30; 
            } else {
                boss.x += 10;
            }

            const hitEffectDiv = document.getElementById('hit-effect');
            hitEffectDiv.style.left = boss.x + 'px';
            hitEffectDiv.style.top = boss.y - 100 + 'px';
            hitEffectDiv.innerText = weapon.text;
            hitEffectDiv.style.color = weapon.color;
            hitEffectDiv.style.opacity = 1;

            setTimeout(() => {
                hitEffectDiv.style.opacity = 0;
            }, 300);
        }
    }
    
    // ------------------------------------------
    // ë“œë¡œì‰ ë° ê²Œì„ ë£¨í”„
    // ------------------------------------------
    
    function drawDoodleRect(x, y, w, h, color) {
        ctx.beginPath();
        ctx.strokeStyle = "black";
        ctx.lineWidth = 3;
        ctx.rect(x, y, w, h);
        ctx.stroke();
        ctx.fillStyle = color + '33';
        ctx.fillRect(x+2, y+2, w-4, h-4);
    }

    function drawPlayer() {
        ctx.beginPath();
        ctx.strokeStyle = "black";
        ctx.lineWidth = 3;
        ctx.moveTo(player.x, player.y);
        ctx.lineTo(player.x, player.y + 40);
        ctx.lineTo(player.x - 10, player.y + 60);
        ctx.moveTo(player.x, player.y + 40);
        ctx.lineTo(player.x + 10, player.y + 60);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(player.x, player.y - 10, 15, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.fill();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(player.x - 10, player.y - 15);
        ctx.quadraticCurveTo(player.x - 25, player.y, player.x - 15, player.y + 5);
        ctx.stroke();
        
        if (player.isAttacking) {
            ctx.strokeStyle = weapons[currentWeapon].color;
            ctx.lineWidth = 5;
            ctx.beginPath();
            
            const weapon = weapons[currentWeapon];
            if (currentWeapon === 0 || currentWeapon === 1) { 
                ctx.moveTo(player.x, player.y + 10);
                ctx.lineTo(player.x + weapon.range, player.y + 5);
                if (currentWeapon === 1) { 
                    ctx.font = "20px Gaegu";
                    ctx.fillStyle = weapon.color;
                    ctx.fillText("ğŸ”¨", player.x + weapon.range - 15, player.y);
                }
            } 
            else if (currentWeapon === 2) { 
                ctx.moveTo(player.x, player.y + 10);
                ctx.lineTo(player.x + weapon.range, player.y + 5); 
                ctx.font = "20px Gaegu";
                ctx.fillStyle = weapon.color;
                ctx.fillText("ğŸ“„", player.x + 40, player.y);
            }
            else if (currentWeapon === 3) { 
                ctx.moveTo(player.x, player.y + 30);
                ctx.lineTo(player.x + weapon.range, player.y + 20);
            }
            ctx.stroke();
        }
    }

    function drawBoss() {
        if (boss.isQuitting) return;

        let shakeX = 0;
        if (boss.isHit) {
            shakeX = (Math.random() - 0.5) * 10;
        }

        const bx = boss.x + shakeX;
        const by = boss.y;

        ctx.beginPath();
        ctx.strokeStyle = "black";
        ctx.lineWidth = 3;
        ctx.moveTo(bx, by);
        ctx.lineTo(bx, by + 40); 
        ctx.lineTo(bx - 10, by + 60); 
        ctx.moveTo(bx, by + 40);
        ctx.lineTo(bx + 10, by + 60);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(bx, by - 10, 18, 0, Math.PI * 2); 
        ctx.fillStyle = "#ffecd1"; 
        ctx.fill();
        ctx.stroke();
        
        ctx.beginPath();
        ctx.arc(bx, by - 10, 18, 0, Math.PI, false); 
        ctx.strokeStyle = "black";
        ctx.stroke();

        ctx.fillStyle = "black";
        ctx.font = "16px Gaegu";
        ctx.fillText(bossName, bx - 20, by + 80);

        const dx = player.x - boss.x;
        const dy = player.y - boss.y;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < TALK_RANGE && !boss.isHit) {
            
            if (speechPhase !== 0) { 
                ctx.beginPath();
                ctx.fillStyle = "white";
                ctx.strokeStyle = "black";
                ctx.roundRect(bx - 100, by - 80, 200, 40, 10);
                ctx.fill();
                ctx.stroke();
                
                ctx.fillStyle = "black";
                ctx.textAlign = "center";
                ctx.font = "18px Gaegu";
                ctx.fillText(currentNag, bx, by - 55);
            }
        } else {
            if(speechPhase !== 0) {
                window.speechSynthesis.cancel();
                isTalking = false;
                speechPhase = 0;
                currentNag = "...";
            }
        }
    }

    function gameLoop() {
        if (!gameRunning) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        desks.forEach(d => {
            drawDoodleRect(d.x, d.y, d.w, d.h, "#8d6e63"); 
            ctx.fillStyle = "black";
            ctx.font = "14px Gaegu";
            ctx.fillText("ì—…ë¬´ì¤‘", d.x + 20, d.y + 30);
        });
        
        updateRageBar(); 

        if (keys['ArrowLeft']) player.x -= player.speed;
        if (keys['ArrowRight']) player.x += player.speed;
        if (keys['ArrowUp']) player.y -= player.speed;
        if (keys['ArrowDown']) player.y += player.speed;

        player.x = Math.max(20, Math.min(canvas.width - 20, player.x));
        player.y = Math.max(20, Math.min(canvas.height - 20, player.y));
        
        drawBoss();
        drawPlayer();

        if (player.isAttacking) {
            player.attackTimer--;
            if (player.attackTimer <= 0) player.isAttacking = false;
        }
        
        if (boss.isHit) {
            boss.hitTimer--;
            if (boss.hitTimer <= 0) {
                boss.isHit = false;
                boss.x = BOSS_START_X; 
                boss.y = BOSS_START_Y;
            }
        }

        requestAnimationFrame(gameLoop);
    }
    
    // ------------------------------------------
    // ê²Œì„ ì‹œì‘ í•¨ìˆ˜ 
    // ------------------------------------------
    function startGame() {
        const input = document.getElementById('bossNameInput').value;
        if(input) bossName = input;
        
        document.getElementById('start-overlay').style.display = 'none';
        document.getElementById('rage-bar-container').style.display = 'flex'; 

        document.getElementById('weapon-guide').innerText = `í˜„ì¬ ë¬´ê¸°: [1] ${weapons[currentWeapon].name}`;
        gameRunning = true;
        
        // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©ì í´ë¦­ í›„ í™•ì‹¤íˆ ì¬ê°œ
        if (audioCtx.state === 'suspended') {
            audioCtx.resume().catch(err => console.error("AudioContext resume failed:", err));
        }

        gameLoop();
    }

    // ------------------------------------------
    // í‚¤ ì…ë ¥ ë° í„°ì¹˜ ë¦¬ìŠ¤ë„ˆ
    // ------------------------------------------
    
    // PC í‚¤ë³´ë“œ ì…ë ¥
    window.addEventListener('keydown', e => {
        if (!gameRunning) return; 

        keys[e.code] = true;

        if (e.code === 'KeyE') {
            checkTalkStart();
        } 
        
        if (e.code === 'Space') { 
            attack(); 
        } 
        
        if (e.key >= '1' && e.key <= '4') {
            setWeapon(parseInt(e.key) - 1);
        }
    });

    window.addEventListener('keyup', e => {
        keys[e.code] = false;
    });

    // ë¬´ê¸° ë³€ê²½ í•¨ìˆ˜
    function setWeapon(index) {
        if (index >= 0 && index < weapons.length) {
            currentWeapon = index;
            document.getElementById('weapon-guide').innerText = `í˜„ì¬ ë¬´ê¸°: [${index + 1}] ${weapons[currentWeapon].name}`;
        }
    }

    // í„°ì¹˜ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function handleButtonStart(e) {
        e.preventDefault();
        if (!gameRunning) return;
        const key = e.currentTarget.dataset.key;
        const weaponIndex = e.currentTarget.dataset.weapon;

        if (key && key !== 'NoKey') {
            keys[key] = true;
            if (key === 'KeyE') checkTalkStart();
            if (key === 'Space') attack();
        }

        // ë¬´ê¸° ë³€ê²½ ë²„íŠ¼ ì²˜ë¦¬
        if (weaponIndex !== undefined) {
            setWeapon(parseInt(weaponIndex));
        }
    }

    function handleButtonEnd(e) {
        e.preventDefault();
        if (!gameRunning) return;
        const key = e.currentTarget.dataset.key;
        if (key && key !== 'NoKey') {
            keys[key] = false;
        }
    }

    controls.forEach(btn => {
        btn.addEventListener('mousedown', handleButtonStart);
        btn.addEventListener('mouseup', handleButtonEnd);
        btn.addEventListener('touchstart', handleButtonStart);
        btn.addEventListener('touchend', handleButtonEnd);
        // í„°ì¹˜ í™˜ê²½ì—ì„œ ë§ˆìš°ìŠ¤ì—…/ë‹¤ìš´ì²˜ëŸ¼ ì‘ë™í•˜ë„ë¡ touchcancel ì¶”ê°€
        btn.addEventListener('touchcancel', handleButtonEnd); 
    });

</script>

</body>
</html>
